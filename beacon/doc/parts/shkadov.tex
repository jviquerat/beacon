%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Shkadov}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Physics}

The first focus on vertically falling fluid films was performed by Kapitza \& Kapitza \cite{kapitza1948}, and gave rise to a large amount of experimental studies in the following decades. These experiments showed that waves on the surface of a falling thin liquid film are strongly non-linear, displaying the development of saturated waves from small amplitude perturbations, as well as the existence of solitary waves. At low Reynolds number ($Re < 300$), it was observed that the wavelength of the non-linear waves was much larger than the thickness of the film, leading to possible simplifications of their physical models (called long-wave regime). Several physical models were then proposed, including the Shkadov model, introduced in 1967 \cite{shkadov1967}. Although it presents a certain lack of consistency \cite{lavalle2014}, this model displays interesting spatio-temporal dynamics while remaining acceptably cheap to integrate numerically. It simultaneously evolves the flow rate $q$ as well as the fluid height $h$ as:

\begin{equation}
\label{eq:shkadov}
\begin{split}
	\partial_t h 	&= -\partial_x q, \\
	\partial_t q		&= - \frac{6}{5} \partial_x \left( \frac{q^2}{h}Â \right) + \frac{1}{5 \delta} \left(  h \left( 1 + \partial_{xxx}h \right) - \frac{q}{h^2} \right),
\end{split}
\end{equation}

\noindent with all the physics of the problem being condensed in the $\delta$ parameter:

\begin{equation}
\label{eq:shkadov_delta}
	\delta = \frac{1}{15} \left( \frac{3 {Re}^2}{W} \right)^{\frac{1}{3}},
\end{equation}

\noindent where $Re$ and $W$ are the Reynolds and the Webber numbers, respectively defined on the flat-film thickness and the flat-film average velocity \cite{chang2002}. The system (\ref{eq:shkadov}) is solved on a 1D domain of length $L$, with the following initial and boundary conditions:

\begin{equation}
\label{eq:shkadov_bc}
\begin{split}
	q(x,0)		= 1 &\text{ and } h(x,0)	= 1, \\
	q(0,t) 		= 1 &\text{ and } h(0,t) 	= 1 + \mathcal{U} ( -\eps, \eps), \\
	\partial_x q(L,t) = 0 &\text{ and } 	\partial_x q(L,t) = 0,
\end{split}
\end{equation}

with $\eps \ll 1$ being the noise level. As shown in figure \ref{fig:shkadov_free}, the introduction of a random uniform noise at the inlet triggers the development of exponentially-growing instabilities (blue region) which eventually develop a pseudo-periodic behavior (orange region). Then, the periodicity of the waves break, and the instabilities transition into pulse-like structures, presenting a steep front preceded by small ripples \cite{chang2002book}. It is observed that some of these steep pulses, called solitary pulses, travel faster than others, and can capture upstream pulses in coalescence events. The dynamics of these solitary pulses are fully determined by the $\delta$ parameter, while the location of the transition regions also depends on the inlet noise level \cite{chang2002}.

\input{fig/shkadov/shkadov_free}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Discretization}

Equations (\ref{eq:shkadov}) are discretized using a finite difference approach. Due to the existence of sharp gradients, the convective terms are discretized using a TVD scheme with a minmod flux limiter. The discretized third-order derivative is obtained by chaining a second-order centered difference for the second derivative, chained with a second-order forward difference, leading to the following second-order approximation:

\begin{equation}
\label{eq:shkadov_fd}
\begin{split}
	\left. \partial_{xxx} h \right|_j 	&\sim \frac{1}{2 \Delta x^3} \left( -h_{j+3} + 6h_{j+2} - 12h_{j+1} + 10 h_j - 3 h_{j-1} \right) \\
							&= \partial_{xxx} h (x_j) + \frac{\Delta x^2}{4} \partial_{xxxxx} h (x_j) + O\left( \Delta x^3 \right).
\end{split}
\end{equation}

Finally, the time derivatives are discretized using a second-order Adams-Bashforth method:

\begin{equation}
\label{eq:adams_bashforth}
	h^{n+1} = h^n + \frac{\Delta t}{2} \left( - 3 f_h \left(h^{n} \right) + f_h \left(h^{n-1} \right) \right),
\end{equation}

\noindent where $f_h$ represents the right hand side of the evolution equation of $h$ in system (\ref{eq:shkadov}), and similarly for $q$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Environment}

The proposed environment is re-implemented based on the original publication of Belus \textit{et al.} \cite{belus2019}, although with some significant differences. It is noted that the translational invariance feature introduced in \cite{belus2019} is \emph{not} exploited here. Contrarily, this control problem is seen as an opportunity to test algorithms with a problem of arbitrarily high action dimensionality.

The control of the system (\ref{eq:shkadov}) is performed by adding a forcing term $\delta q_j$ to the equation driving the temporal evolution of the flow rate. In practice, this is achieved by adding localized jets at certain positions in the domain, as shown in figure \ref{fig:shkadov_jets}, which strengths are to be controlled by the DRL agent. The first jet is positioned by default at $x_0=150$, with jet spacing being by default set to $\Delta x_\text{jets} = 10$, similarly to \cite{belus2019}. To save computational time, the length of the domain is a function of the number of jets $n_\text{jets}$ and their spacing:

\begin{equation}
	L = L_0 + \left( n_\text{jets} + 2\right) \Delta x_\text{jets}.
\end{equation}

By default, $L_0 = 150$ (which corresponds to the start of the pseudo-periodic region for $\delta = 0.1$), and $n_\text{jets}$ is set equal to 1. The spatial discretization step is set as $\Delta x = 0.5$, while the numerical time step is $\Delta t = 0.005$. The inlet noise level is set as $\eps = \num{5e-4}$, similarly to \cite{belus2019}. The injected flow rate $\delta q_j$ has the following form:

\begin{equation}
\label{eq:shkadov_jets}
	\delta q_j (x,t) = A u_j(t) \frac{4 \left( x - x_j^l \right) \left( x_j^r - x \right)}{ \left( x_j^r - x_j^l \right)^2},
\end{equation}

with $A=5$ an \textit{ad-hoc} non-dimensional amplitude factor, $x_j^l$ and $x_j^r$ the left and right limits of jet $j$, and $u_j(t) \in [-1,1]$ the action provided by the agent. Expression (\ref{eq:shkadov_jets}) corresponds to a parabolic profile of the jet in $x$, such that the injected flow rate drops to $0$ on the boundaries of each jet. The jet width $x_j^r - x_j^l$ is set equal to $4$, similarly to \cite{belus2019}. The time dependance of $u(t)$ is implemented as a saturated linear variation from an action to the next one, in the form:

\begin{equation}
\label{eq:shkadov_actions}
	u_j(t) = (1-\alpha(t)) u_j^{n-1} + \alpha(t) u_j^n \text{, with } \alpha(t) = \min \left( \frac{t-t_n}{\Delta t_\text{int}}, 1 \right),
\end{equation}

Hence, when the actor provides a new action to the environment at time $t=t_n$, the real imposed action is a linear interpolation between the previous action $u_j^{n-1}$ and the new action $u_j^n$ over a time $\Delta t_\text{int}$ (here taken equal to $0.01$ time units), after what the new action is imposed over the remaining action time $\Delta t_\text{const}$ (here taken equal to $0.04$ time units). The total action time-step is therefore $\Delta t_\text{act} = \Delta t_\text{int} + \Delta t_\text{const}$, which value is therefore equal to $0.05$ time units. The total episode time is fixed to $20$ time units, corresponding to $400$ actions.

\input{fig/shkadov/shkadov_jets}

The observations provided to the agent are the mass flow rates collected in the union of regions $A^j_\text{obs}$ of length $l_\text{obs} = 10$ located upstream of each jet, as shown in figure \ref{fig:shkadov_jets}. Contrarily to the original article, the flow heights of this region are not provided to the agent, and the observations are not clipped.

The reward for each jet $j$ is computed on a region $A^j_\text{rwd}$ of length $l_\text{rwd} = 10$ located downstream of it (see figure \ref{fig:shkadov_jets}), the global reward consisting of a weighted sum of each individual reward:

\begin{equation}
\label{eq:shkadov_reward}
	r(t) = - \frac{1}{l_\text{rwd} \, n_\text{jets}} \sum_{j=0}^{n_\text{jets}-1} \sum_{x \in A^j_\text{rwd}} (h(x,t) - 1)^2
\end{equation}

Hence, the maximal reward is $0$ for a perfectly flat film, and the normalization factor allows to compare scores for problems of increasing complexity (\textit{i.e.} with increasing number of jets).

Finally, each episode starts with the loading of a fully developed initial state obtained by solving the uncontrolled equations from an initial flat film configuration during a time $t_\text{init} = 200$ time units. For convenience, this field is stored in a file and is loaded at the beginning of each episode. In case of modified parameters (spatial discretization, physical parameter...), this file can be generated by running the \codeinline{init.py} routine. The initial state can be optionally made random by freely evolving the loaded initial configuration between $0$ and $20$ time units.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}

The environment as described in the previous section is referred to as \codeinline{shkadov-v0}, and its default parameters are provided in table \ref{table:shkadov_parameters}. In this section, we present some results related to its resolution using a \textsc{ppo} agent (see the general hyperparameters in table \ref{table:default_ppo_parameters}). For the training, we set $n_\text{rollout} = 3200$, $n_\text{batch} = 2$, $n_\text{epoch} = 32$ and $n_\text{max} = 300k$.

We consider the training on the environment using $1$, $5$ and $10$ jets (see figure \ref{fig:shkadov_score}). As could be expected, training is faster for small number of jets, while for larger amount of jets the \textsc{ppo} algorithm struggles due to the increasing dimensionality. In figure \ref{fig:shkadov_fields}, we present the evolution of the field in time under the control of the agent for 10 jets using the default parameters. As can be observed, the agent quickly constrains the height of the fluid around $h=1$, before entering a quasi-stationary state in which a set of minimal, quasi constant jet actuations keeps the flow from developing instabilities.

%%%%%%%%%%%%
%%%%%%%%%%%%
\begin{table}
    \footnotesize
    \caption{\textbf{Default parameters used for the \codeinline{shkadov-v0} environment.}}
    \label{table:shkadov_parameters}
    \centering
    \begin{tabular}{rll}
        \toprule
        \codeinline{L0}			& base length of domain					& $150$\\
	\codeinline{n_jets}		& number of jets						& $5$\\
	\codeinline{jet_pos}		& position of first jet						& $150$\\
	\codeinline{jet_space}	& spacing between jets					& $10$\\
	\codeinline{delta}		& physical parameter (\ref{eq:shkadov_delta})	& $0.1$\\
        \bottomrule
    \end{tabular}
\end{table}
%%%%%%%%%%%%
%%%%%%%%%%%%

\input{fig/shkadov/score}

\input{fig/shkadov/fields}
