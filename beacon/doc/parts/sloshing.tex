%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Sloshing}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Physics}

We consider the resolution of the 1D Saint-Venant equations (or shallow water equations), established in 1871 \cite{saintvenant1871}, which describe a shallow layer of fluid in hydrostatic balance with constant density. This system is considered in the context of a water tank of length $L$ moving subject to an acceleration $\ddot{y}$, leading to the following equations in the tank referential \cite{berger2022}:

\begin{equation}
\label{eq:stvenant}
\begin{split}
	\partial_t h 	&= -\partial_x q, \\
	\partial_t q		&= -\partial_x \left( \frac{q^2}{h} + \frac{1}{2} g h^2 \right) - \ddot{y},
\end{split}
\end{equation}

where $h$ is the fluid height, and $q$ is the fluid flow rate. The system (\ref{eq:stvenant}) is completed by the following initial and boundary conditions:

\begin{equation}
\label{eq:stvenant_bc}
\begin{split}
	q(x,0)	= 0 &\text{ and } h(x,0)	= 1, \\
	q(0,t) 	= 0 &\text{ and } \partial_x h(0,t) = 0, \\
	q(L,t) 	= 0 &\text{ and } \partial_x h(L,t) = 0.
\end{split}
\end{equation}

The situation is summed up in figure \ref{fig:sloshing_tank}. When excited laterally, the surface of the fluid sloshes back and forth in the tank generating complex patterns at the fluid surface, as shown in figure \ref{fig:sloshing_examples}. When the excitation stops, a relaxation phase is observed, usually leaving a single wavefront travelling back and forth in the tank until it dissipates entirely. Due to its simplicity, the model (\ref{eq:stvenant}) does not allow wave breaking nor the formation of drops on the sides of the domain.

\input{fig/sloshing/tank}

\input{fig/sloshing/sloshing_free}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Discretization}

The system (\ref{eq:stvenant}) is discretized using a finite volume scheme with Rusanov fluxes \cite{cordier2007}, which is an improved form of the Lax-Friedrichs flux. The time derivatives for both $h$ and $q$ are discretized using the second-order Adams-Bashforth scheme, already introduced in (\ref{eq:adams_bashforth}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Environment}

The control of the system (\ref{eq:stvenant}) is performed through the cart acceleration term $\ddot{y}$. The system is first set in motion during $t_\text{exc} = 2$ time units using a sinusoid-based signal:

\begin{equation}
	\ddot{y}_\text{exc} (t) = \frac{1}{2} \left( \cos ( \pi t ) + 3 \cos ( 4 \pi t) \right).
\end{equation}

The resulting fields are stored on file for simplicity, and loaded at the beginning of each episode. By default, the length of the cart is $L = 2.5$, the spatial discretization corresponds to $100$ finite volume cells per unit of length, and the numerical time step is $\Delta t = 0.001$ time units. The actions provided to the environment, which are expected to be in $\left[-1, 1\right]$, are then scale by an \textit{ad-hoc} non-dimensional amplitude factor $A=2$. The interpolation between successive actions is identical to (\ref{eq:shkadov_actions}), with $\Delta t_\text{int} = 0.01$ time units and $\Delta t_\text{act} = 0.05$ time units. The total episode time is fixed to $10$ time units, corresponding to $200$ actions. The observations provided to the agent are the heights collected on the entire domain. To limit the size of the resulting vector, it is downsampled by a factor 2. Finally, the reward signal is defined as:

\begin{equation}
\label{eq:sloshing_reward}
	r(t) = - \Delta x \norm{h(x,t) - 1}_2 - \alpha \left| \ddot{y} (t) \right|,
\end{equation}

where $\norm{\cdot}_2$ is the $2$-norm and $\alpha = 0.0005$. The $\Delta x$ factor allows to obtain comparable reward values for variable discretization levels.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}

The environment as described in the previous section is referred to as \codeinline{sloshing-v0}, in the fashion of the \textsc{gym} environments (the default parameters of the environment are provided in table \ref{table:sloshing_parameters}). In this section, we provide some results related to its resolution using a \textsc{ppo} agent (see the general hyperparameters in table \ref{table:default_ppo_parameters}). For the training, we set $n_\text{rollout} = 2000$, $n_\text{batch} = 2$, $n_\text{epoch} = 16$ and $n_\text{max} = 200k$.

The score curve obtained with the PPO algorithm is presented in \ref{fig:sloshing_score}, while the time evolutions of the controlled versus uncontrolled fluid level are shown in figure \ref{fig:sloshing_fields}. As can be observed, the agent manages to roughly cut the uncontrolled reward in half, by suppressing the back and forth wavefront using large actuations in the early stages of control, after what the control amplitude drops significantly.

%%%%%%%%%%%%
%%%%%%%%%%%%
\begin{table}
    \footnotesize
    \caption{\textbf{Default parameters used for the \codeinline{sloshing-v0} environment.}}
    \label{table:sloshing_parameters}
    \centering
    \begin{tabular}{rll}
        \toprule
        \codeinline{L}			& length of the tank						& $2.5$\\
	\codeinline{amp}		& amplitude of the control					& $5$\\
	\codeinline{alpha}		& control penalization					& $0.0005$\\
	\codeinline{g}			& gravity acceleration					& $9.81$\\
        \bottomrule
    \end{tabular}
\end{table}
%%%%%%%%%%%%
%%%%%%%%%%%%
%
\input{fig/sloshing/score}
%
\input{fig/sloshing/fields}
