%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Sloshing}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Physics}

We consider the resolution of the 1D Saint-Venant equations (or shallow water equations), established in 1871 \cite{saintvenant1871}, which describe a shallow layer of fluid in hydrostatic balance with constant density. This system is considered in the context of a water tank of length $L$ moving with a velocity $\dot{y}$, leading to the following equations in the tank referential \cite{berger2022}:

\begin{equation}
\label{eq:stvenant}
\begin{split}
	\partial_t h 	&= -\partial_x q, \\
	\partial_t q		&= -\partial_x \left( \frac{q^2}{h} + \frac{1}{2} g h^2 \right) - \ddot{y},
\end{split}
\end{equation}

where $h$ is the fluid height, and $q$ is the fluid flow rate. The system (\ref{eq:stvenant}) is completed by the following initial and boundary conditions:

\begin{equation}
\label{eq:stvenant_bc}
\begin{split}
	q(x,0)	&= 0 \text{ and } h(x,0)	= 1, \\
	q(0,t) 	&= 0 \text{ and } \partial_x h(0,t) = 0, \\
	q(L,t) 	&= 0 \text{ and } \partial_x h(L,t) = 0.
\end{split}
\end{equation}

The situation is summed up in figure \ref{fig:sloshing_tank}. When excited laterally, the surface of the fluid sloshes back and forth in the tank generating complex patterns at the fluid surface, as shown in figure \ref{fig:sloshing_examples}. When the excitation stops, a relaxation phase is observed, usually leaving a single wavefront travelling back and forth in the tank until it dissipates entirely. Due to its simplicity, the model (\ref{eq:stvenant}) does not allow wave breaking nor the formation of drops on the sides of the domain.

\input{fig/sloshing/tank}

\input{fig/sloshing/sloshing_free}

%with $\eps \ll 1$ being the noise level. As shown in figure \ref{fig:shkadov_free}, the introduction of a random uniform noise at the inlet triggers the development of exponentially-growing instabilities (blue region) which eventually develop a pseudo-periodic behavior (orange region). Then, the periodicity of the waves break, and the instabilities transition into pulse-like structures, presenting a steep front preceded by small ripples \cite{chang2002book}. It is observed that some of these steep pulses, called solitary pulses, travel faster than others, and can capture upstream pulses in coalescence events. The dynamics of these solitary pulses are fully determined by the $\delta$ parameter, while the location of the transition regions also depends on the inlet noise level \cite{chang2002}.
%
%\input{fig/shkadov/shkadov_free}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Discretization}

%Equations (\ref{eq:shkadov}) are discretized using a finite difference approach. Due to the existence of sharp gradients, the convective terms are discretized using a TVD scheme with a minmod flux limiter. The discretized third-order derivative is obtained by chaining a second-order centered difference for the second derivative, chained with a second-order forward difference, leading to the following second-order approximation:
%
%\begin{equation}
%\label{eq:shkadov_fd}
%\begin{split}
%	\left. \partial_{xxx} h \right|_j 	&\sim \frac{1}{2 \Delta x^3} \left( -h_{j+3} + 6h_{j+2} - 12h_{j+1} + 10 h_j - 3 h_{j-1} \right) \\
%							&= \partial_{xxx} h (x_j) + \frac{\Delta x^2}{4} \partial_{xxxxx} h (x_j) + O\left( \Delta x^3 \right).
%\end{split}
%\end{equation}
%
%Finally, the time derivatives are discretized using a second-order Adams-Bashforth method:
%
%\begin{equation}
%\label{eq:adams_bashforth}
%	h^{n+1} = h^n + \frac{\Delta t}{2} \left( - 3 f_h \left(h^{n} \right) + f_h \left(h^{n-1} \right) \right),
%\end{equation}
%
%\noindent where $f_h$ represents the right hand side of the evolution equation of $h$ in system (\ref{eq:shkadov}), and similarly for $q$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Environment}

%The proposed environment is re-implemented based on the original publication of Belus \textit{et al.} \cite{belus2019}, although with some significant differences. It is noted that the translational invariance feature introduced in \cite{belus2019} is \emph{not} exploited here. Contrarily, this control problem is seen as an opportunity to test algorithms with a problem of arbitrarily high action dimensionality.
%
%The control of the system (\ref{eq:shkadov}) is performed by adding a forcing term $\delta q_j$ to the equation driving the temporal evolution of the flow rate. In practice, this is achieved by adding localized jets at certain positions in the domain, as shown in figure \ref{fig:shkadov_jets}, which strengths are to be controlled by the DRL agent. The first jet is positioned by default at $x_0=150$, with jet spacing being by default set to $\Delta x_\text{jets} = 10$, similarly to \cite{belus2019}. To save computational time, the length of the domain is a function of the number of jets $n_\text{jets}$ and their spacing:
%
%\begin{equation}
%	L = L_0 + \left( n_\text{jets} + 2\right) \Delta x_\text{jets}.
%\end{equation}
%
%By default, $L_0 = 150$ (which corresponds to the start of the pseudo-periodic region for $\delta = 0.1$), and $n_\text{jets}$ is set equal to 1. The spatial discretization step is set as $\Delta x = 0.5$, while the numerical time step is $\Delta t = 0.005$. The inlet noise level is set as $\eps = \num{5e-4}$, similarly to \cite{belus2019}. The injected flow rate $\delta q_j$ has the following form:
%
%\begin{equation}
%\label{eq:shkadov_jets}
%	\delta q_j (x,t) = A u_j(t) \frac{4 \left( x - x_j^l \right) \left( x_j^r - x \right)}{ \left( x_j^r - x_j^l \right)^2},
%\end{equation}
%
%with $A=5$ an \textit{ad-hoc} non-dimensional amplitude factor, $x_j^l$ and $x_j^r$ the left and right limits of jet $j$, and $u_j(t) \in [-1,1]$ the action provided by the agent. Expression (\ref{eq:shkadov_jets}) corresponds to a parabolic profile of the jet in $x$, such that the injected flow rate drops to $0$ on the boundaries of each jet. The jet width $x_j^r - x_j^l$ is set equal to $4$, similarly to \cite{belus2019}. The time dependance of $u(t)$ is implemented as a saturated linear variation from an action to the next one, in the form:
%
%\begin{equation}
%\label{eq:shkadov_actions}
%	u_j(t) = (1-\alpha(t)) u_j^{n-1} + \alpha(t) u_j^n \text{, with } \alpha(t) = \min \left( \frac{t-t_n}{\Delta t_\text{int}}, 1 \right),
%\end{equation}
%
%Hence, when the actor provides a new action to the environment at time $t=t_n$, the real imposed action is a linear interpolation between the previous action $u_j^{n-1}$ and the new action $u_j^n$ over a time $\Delta t_\text{int}$ (here taken equal to $0.01$ time units), after what the new action is imposed over the remaining action time $\Delta t_\text{const}$ (here taken equal to $0.04$ time units). The total action time-step is therefore $\Delta t_\text{act} = \Delta t_\text{int} + \Delta t_\text{const}$, which value is therefore equal to $0.05$ time units. The total episode time is fixed to $20$ time units, corresponding to $400$ actions.
%
%\input{fig/shkadov/shkadov_jets}
%
%The observations provided to the agent are the heights collected in the union of regions $A^j_\text{obs}$ of length $l_\text{obs} = 10$ located upstream of each jet, as shown in figure \ref{fig:shkadov_jets}. Contrarily to the original article, the flow rates of this region are not provided to the agent, and the observations are not clipped.
%
%The reward for each jet $j$ is computed on a region $A^j_\text{rwd}$ of length $l_\text{rwd} = 10$ located downstream of it (see figure \ref{fig:shkadov_jets}), the global reward consisting of a weighted sum of each individual reward:
%
%\begin{equation}
%\label{eq:shkadov_reward}
%	r(t) = - \frac{1}{l_\text{rwd} \, n_\text{jets}} \sum_{j=0}^{n_\text{jets}-1} \sum_{x \in A^j_\text{rwd}} (h(x,t) - 1)^2
%\end{equation}
%
%Hence, the maximal reward is $0$ for a perfectly flat film, and the normalization factor allows to compare scores for problems of increasing complexity (\textit{i.e.} with increasing number of jets).
%
%Finally, each episode starts with the loading of a fully developed initial state obtained by solving the uncontrolled equations from an initial flat film configuration during a time $t_\text{init} = 200$ time units. For convenience, this field is stored in a file and is loaded at the beginning of each episode. In case of modified parameters (spatial discretization, physical parameter...), this file can be generated by running the \codeinline{init.py} routine.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}

%The environment as described in the previous section is referred to as \codeinline{shkadov-v0}, in the fashion of the \textsc{gym} environments (the default parameters of the environment are provided in table \ref{table:shkadov_parameters}). In this section, we provide some results related to its resolution using a \textsc{ppo} agent (the set of hyperparameters used for the resolution is provided in table \ref{table:shkadov_ppo_parameters}). First, we consider the training on the environment using $1$, $5$ and $10$ jets, the training being performed on $300k$ steps (see figure \ref{fig:shkadov_score}). As could be expected, training is faster for small number of jets, while for larger amount of jets, training with regular \textsc{ppo} algorithm under this set of hyperparameters becomes extremely slow, or does not happen at all. In figure \ref{fig:shkadov_fields}, we present the evolution of the field in time under the control of the agent for 10 jets using the default parameters. As can be observed, the agent quickly constrains the height of the fluid around $h=1$, before entering a quasi-stationary state in which a set of minimal, quasi constant jet actuations keeps the flow from developing instabilities.
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{table}
%    \footnotesize
%    \caption{\textbf{Default parameters used for the \codeinline{shkadov-v0} environment.}}
%    \label{table:shkadov_parameters}
%    \centering
%    \begin{tabular}{rll}
%        \toprule
%        \codeinline{L0}			& base length of domain					& $150$\\
%	\codeinline{n_jets}		& number of jets						& $5$\\
%	\codeinline{jet_pos}		& position of first jet						& $150$\\
%	\codeinline{jet_space}	& spacing between jets					& $10$\\
%	\codeinline{delta}		& physical parameter (\ref{eq:shkadov_delta})	& $0.1$\\
%        \bottomrule
%    \end{tabular}
%\end{table}
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%\begin{table}
%    \footnotesize
%    \caption{\textbf{Default parameters used for the \textsc{ppo} agent.}}
%    \label{table:shkadov_ppo_parameters}
%    \centering
%    \begin{tabular}{rll}
%        \toprule
%        --					& agent type					& PPO-clip\\
%	$\gamma$ 			& discount factor				& 0.99\\
%	$\lambda_a$ 			& actor learning rate				& \num{1e-3}\\
%	$\lambda_c$ 			& critic learning rate				& \num{5e-3}\\
%	--		 			& optimizer					& adam\\
%	--					& weights initialization			& orthogonal\\
%	--	 				& activation (actor hidden layers)	& tanh\\
%	-- 					& activation (actor final layer)		& tanh, sigmoid\\
%	--	 				& activation (critic hidden layers)	& relu\\
%	-- 					& activation (critic final layer)		& linear\\
%	$\epsilon$ 			& PPO clip value				& 0.2\\
%	$\beta$				& entropy bonus				& 0.01\\
%	$g$					& gradient clipping value			& 0.1\\	
%	-- 					& actor network					& $[64, [[64],[64]]]$\\
%	-- 					& critic network					& $[64, 64]$\\
%	--					& observation normalization		& yes\\
%	--					& observation clipping			& no\\
%	--					& advantage type				& GAE\\
%	$\lambda_\text{GAE}$	& bias-variance trade-off			& 0.95\\
%	--					& advantage normalization		& yes\\\midrule
%	$n_\text{rollout}$ 		& nb. of transitions per update		& 4000\\
%	$n_\text{batch}$ 		& nb. of minibatches per update 	& 2\\
%	$n_\text{epoch}$		& nb. of epochs per update		& 32\\
%	$n_\text{max}$			& total nb. of transitions per training	& \num{300000}\\
%	$n_\text{training}$		& total nb. of averaged trainings	& 5\\
%        \bottomrule
%    \end{tabular}
%\end{table}
%%%%%%%%%%%%%
%%%%%%%%%%%%%
%
%\input{fig/shkadov/score}
%
%\input{fig/shkadov/fields}
